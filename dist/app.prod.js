"use strict";var userName,express=require("express"),bodyParser=require("body-parser"),path=require("path"),objectId=require("mongodb").ObjectID,session=require("express-session"),mongoose=require("mongoose"),MongoStore=require("connect-mongo")(session),User=require("./models/user"),Device=require("./models/device"),Comment=require("./models/comment"),routes=require("./routes"),config=require("./config"),app=express();app.use(session({secret:config.SESSION_SECRET,resave:!0,saveUninitialized:!1,store:new MongoStore({mongooseConnection:mongoose.connection})})),app.set("view engine","ejs"),app.use(bodyParser.urlencoded({extended:!0})),app.use(bodyParser.json()),app.use(express.static(path.join(__dirname,"public"))),app.use("/javascripts",express.static(path.join(__dirname,"node_modules","jquery","dist"))),app.use("/api/auth",routes.auth);var templates=[["Коридор","Прихожая","Ванная","Кухня","Спальня"],["Коридор","Прихожая","Ванная","Кухня","Спальня","Детская"],["Коридор","Прихожая","Ванная","Кухня","Спальня","Детская","Гостинная"]],types=["Розетки","Климат-контроль","Солнцезащитные конструкции","Бытовые приботы","Освещение"];app.get("/",function(e,n){n.render("index")}),app.get("/user",function(e,n){userName=e.session.userLogin,User.findOne({login:userName}).then(function(e){n.render("user",{userName:e.login,password:e.password,phone:e.phone,email:e.email})})}),app.get("/home",function(e,n){User.findOne({login:userName}).then(function(e){console.log(e.template),n.render("home",{userName:e.login,homeName:e.homeLogin,template:e.template})})}),app.get("/devices",function(e,o){User.findOne({login:userName}).then(function(n){Device.find({userLogin:n.login}).then(function(e){o.render("devices",{userName:n.login,types:types,templates:templates[n.template],devices:e})})})}),app.get("/help",function(e,n){User.findOne({login:userName}).then(function(e){n.render("help",{userName:e.login,email:e.email})})}),app.get("/add",function(e,n){User.findOne({login:userName}).then(function(e){n.render("add",{userName:e.login,types:types,templates:templates[e.template]})})}),app.get("/edit/:id",function(t,i){User.findOne({login:userName}).then(function(n){var e=t.params.id.slice(1),o=new objectId(e);Device.findOne({_id:o}).then(function(e){console.log(e),i.render("edit",{userName:n.login,types:types,templates:templates[n.template],device:e})})})}),app.get("/about",function(e,o){User.findOne({login:userName}).then(function(n){Comment.find({}).then(function(e){console.log(e),o.render("about",{userName:n.login,comments:e})})})}),app.get("*",function(e,n){User.findOne({login:userName}).then(function(e){n.render("404",{userName:e.login})})}),app.post("/user",function(e,n){User.findOne({login:userName}).then(function(e){n.send({password:e.password,phone:e.phone,email:e.email})})}),app.post("/home",function(n,o){var e=n.body,t=e.homeLogin,i=e.template,s=e.submit;"save"==s&&User.findOne({login:userName}).then(function(e){User.updateOne({login:e.login},{$set:{homeLogin:t?n.body.homeLogin:e.homeLogin,template:i?n.body.templat:e.template}},function(e,n){console.log(n),o.json({mess:"Данные успешно обновлены!"})})}),"cancel"==s&&User.findOne({login:userName}).then(function(e){o.send({homeLogin:e.homeLogin,template:e.template})})}),app.post("/add",function(e,n){var o=e.body,t=o.name,i=o.type,s=o.room;null!=t&&null!=i&&null!=s&&Device.create({login:t,userLogin:userName,room:s,type:i,condition:"0"}).then(function(e){n.redirect("/devices"),console.log(e.id)})}),app.post("/help",function(e,n){var o=e.body,t=o.name,i=o.email,s=o.mess;console.log(t+" - "+i+": "+s)}),app.post("/about",function(e,n){var o=e.body.text;e.body.save&&null!=o&&Comment.create({login:userName,text:o}).then(function(e){console.log(e.id),n.redirect("/about")}),e.body.cancel&&n.redirect("/about")}),app.post("/edit/:id",function(n,o){var e=n.params.id.slice(1),t=new objectId(e);n.body.save&&Device.findOne({_id:t}).then(function(e){Device.updateOne({_id:t},{$set:{login:n.body.name?n.body.name:e.login,room:n.body.room?n.body.room:e.room,type:n.body.type?n.body.type:e.type}},function(e,n){console.log(n),o.redirect("/devices")})}),n.body.cancel&&o.redirect("/devices")}),app.delete("/devices/:id",function(e,o){var n=e.params.id;Device.findByIdAndDelete(n,function(e,n){return e?console.log(e):void o.send(n)})}),app.post("/devices/:value",function(e,o){var t=e.params.value;User.findOne({login:userName}).then(function(e){console.log(t),console.log(templates[e.template].indexOf(t)),console.log(types.indexOf(t)),-1==types.indexOf(t)&&-1==templates[e.template].indexOf(t)?Device.findOne({_id:t}).then(function(e){console.log(e),Device.updateOne({_id:t},{$set:{condition:"1"==e.condition?"0":"1"}},function(e,n){console.log(n),Device.findOne({_id:t}).then(function(e){o.send(e.condition)})})}):Device.find({$or:[{room:t},{type:t}]}).then(function(e){o.send(e)})})}),module.exports=app;